#!/bin/bash
#DO NOT EDIT THIS FILE.  IT IS MAINTAINED THROUGH EROS.
#Author: David Gitz
#Purpose: Launches Software
source /home/robot/scripts/simple_logger.sh
#declare -a Devices=("MasterModule" "ControlModule1" "dgitzrosmaster" "ControlModule2" "ComputeModule1" "BuildServer1" "dgitzdev")

function launch_device()
{
    sudo chown -R robot /dev/ttyUSB0
    echo -ne "|\x$(printf %x 157)|\x$(printf %x 187)|\x$(printf %x 188)" > /dev/ttyUSB0
    echo -ne '|-BOOTING: '$(date) > /dev/ttyUSB0
    source /home/robot/catkin_ws/devel/setup.bash
    #touch ~/$1
    counter=0
	countmax=5 # Try for about 5 minutes
	ros_connected=0
    while [ $counter -lt $countmax ]
	do
        log_message "Searching for ROS Connection"
        OUTPUT="$(/opt/ros/$ROS_DISTRO/bin/rosnode list)"
        if [[ $OUTPUT = *[!\ ]* ]]; then
			let ros_connected=1
            break
        else
            sleep 5
        fi
        	let counter=$counter+1
		v=$countmax
		let v=$v-$counter
    	echo "Trying to contact ROS Server "$v" more times."
    	if [ $counter -eq $countmax ]; then
			echo "Unable to contact ROS Master."
		fi
    done
    log_message "MY HOSTNAME: "$HOSTNAME
    export ROS_HOSTNAME=$HOSTNAME
    export ROS_IP=$HOSTNAME
    export ROS_MASTER_URI=http://MasterModule:11311
    log_message "ROS_MASTER: "$ROS_MASTER_URI
    log_message "ROS HOSTNAME: "$ROS_HOSTNAME
    cd /home/robot/catkin_ws/
	if [ $ros_connected -eq 1 ]; then
		log_message "Launching Device."
        for filename in "/home/robot/catkin_ws/src/running_config/launch"/*
        do
            launch="${filename##*/}"
            launch_command="roslaunch running_config "$launch" &"
            echo $launch_command
            eval $launch_command
            sleep 2
        done
		#var=$(find /home/robot/catkin_ws/src -iname $1.launch)
		#if [ -z "$var" ]; then
		#	echo "No Launch File for: "$1
		#else
        #    launch_command="roslaunch icarus_rover_v2 "$1"_AlwaysOn.launch &"
	    #		eval $launch_command
	    #		launch_command="roslaunch icarus_rover_v2 "$1".launch &"
	    #		eval $launch_command
        #    #launch_command="roslaunch raspicam_node camerav1_1280x720.launch &"
        #    #eval $launch_command
            
		#fi
	fi
    echo -ne '|-STARTING: '$(date) > /dev/ttyUSB0
}
function print_usage()
{
    echo "Usage Instructions: launchDevice"
    echo "No Options: This Menu"
    echo "-?/-h This Menu"
    echo "-d <hostname> Launch device on this hostname.  Note: This program only works when ran locally."
    exit
}
if [ -z "$1" ]
then
   print_usage
   exit
fi
while getopts ":?hd:" options; do
    case $options in
        d) launch_device $OPTARG;;
        *) print_usage ;;
    esac
done

