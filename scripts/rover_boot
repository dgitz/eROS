#!/bin/bash
#DO NOT EDIT THIS FILE.  IT IS MAINTAINED THROUGH EROS.
#Author: David Gitz

ros_master="MasterModule"
boot_file="/var/log/output/"$(hostname)"_log.txt"
sudo chown robot:robot $boot_file
sudo chown robot:robot /etc/hosts
sudo chmod 664 /etc/hosts
mkdir -p /var/log/output/
rm $boot_file
touch $boot_file
sleep 2
export ROS_HOSTNAME=$HOSTNAME
export ROS_MASTER_URI=http://$ros_master:11311
export ROS_IP=$HOSTNAME


if [[ $HOSTNAME == *"ControlModule"* ]]; then
    echo "ControlModule init" >> $boot_file
    echo 0 | sudo dd status=none of=/sys/class/leds/led1/brightness
    
elif [[ $HOSTNAME == *"ComputeModule"* ]]; then
  echo "ComputeModule init" >> $boot_file
  sudo mount /dev/sda1 /home/robot/external/ -o uid=robot -o gid=robot
fi

ulimit -c unlimited
sudo bash -c 'echo core.%e.%p > /proc/sys/kernel/core_pattern'
sleep 5


sudo chown -R robot /var/log/

echo "Starting Boot Script at: "$(date) >> $boot_file
#Device Type launch stuff
if [[ $HOSTNAME == *"ControlModule"* ]]; then
  echo "ControlModule booting" >> $boot_file
  echo "Setting permissions on SPI" >> $boot_file
  sudo chown robot:robot /dev/spidev0.0
  sudo chown robot:robot /dev/spidev0.1
  echo "Setting permissions on Video" >> $boot_file
  sudo chown robot /dev/video0
  sudo chown robot /dev/vchiq
  echo 1 | sudo dd status=none of=/sys/class/leds/led1/brightness
  mkdir -p /home/robot/storage/DATALOGS/
  mkdir -p /home/robot/storage/SNAPSHOT/SYSTEMSNAPSHOT/
  mkdir -p /home/robot/storage/SNAPSHOT/DEVICESNAPSHOT/
  sudo chown robot:robot /home/robot/storage/DATALOGS/
  sudo chown robot:robot /home/robot/storage/SNAPSHOT/SYSTEMSNAPSHOT/
  sudo chown robot:robot /home/robot/storage/SNAPSHOT/DEVICESNAPSHOT/
  #cd /home/robot/linux-dash/app/server
  #echo "Starting Dashboard Server" >> $boot_file
  #sudo node index.js --port 81 2>> $boot_file >> $boot_file &
  #echo "Starting Watchdog" >> $boot_file
  #sudo service watchdog start
  #sleep 1
  #sudo service watchdog status >> $boot_file

elif [[ $HOSTNAME == *"ComputeModule"* ]]; then
  echo "ComputeModule booting" >> $boot_file
fi

#Specific Device launch stuff
if [[ $HOSTNAME == "MasterModule" ]]; then
  echo "MasterModule booting" >> $boot_file
  echo "Setting permissions on SPI" >> $boot_file
  sudo chown robot:robot /dev/spidev0.0
  sudo chown robot:robot /dev/spidev0.1
  echo "Setting permissions on Video" >> $boot_file
  sudo chown robot /dev/video0
  sudo chown robot /dev/vchiq
  echo 1 | sudo dd status=none of=/sys/class/leds/led1/brightness

  source /home/robot/catkin_ws/devel/setup.bash
  echo "Starting ROSCore" >> $boot_file
  exec roscore 2>> $boot_file > /dev/null &
  
elif [[ $HOSTNAME == "ControlModule1" ]]; then
  mpg321 -g 30 /home/robot/storage/AUDIO/output/RobotPoweringUp.mp3
  cd /home/robot/catkin_ws
fi
echo "Completed Boot at: "$(date) >> $boot_file


if [[ $HOSTNAME == *"ControlModule"* ]]; then
    rosnode kill --all
    sleep 3
    echo "Launching Device" >> $boot_file
    /home/robot/scripts/launchDevice -d $HOSTNAME
fi


echo "Launching auxiliary nodes on modules." >> $boot_file
if [[ $HOSTNAME == "ControlModule1" ]]; then
    cd /home/robot/catkin_ws
    source /home/robot/catkin_ws/devel/setup.bash
    rosnode kill /raspicam_node
    sleep 3
    echo "starting nodes" >> $boot_file
    roslaunch raspicam_node camera.launch >> $boot_file 2>&1 &
    roslaunch sound_play soundplay_node.launch >> $boot_file 2>&1 &
fi
echo "Finished Launch." >> $boot_file
