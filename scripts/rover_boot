#!/bin/bash
#DO NOT EDIT THIS FILE.  IT IS MAINTAINED THROUGH EROS.
#Author: David Gitz
source /home/robot/scripts/simple_logger.sh
ros_master="MasterModule"
sudo chown robot:robot /etc/hosts
sudo chown robot:robot /home/robot/config/ActiveNodes
sudo chown robot:robot /home/robot/config/AllNodeList
sudo chown robot:robot /home/robot/unsorted
sudo chmod 664 /etc/hosts
sudo mv /tmp/hosts /etc/hosts
#sleep 1
export ROS_HOSTNAME=$HOSTNAME
export ROS_MASTER_URI=http://$ros_master:11311
export ROS_IP=$HOSTNAME


if [[ $HOSTNAME == *"ControlModule"* ]]; then
    log_message "ControlModule init"
    echo 0 | sudo dd status=none of=/sys/class/leds/led1/brightness
    
elif [[ $HOSTNAME == *"ComputeModule"* ]]; then
  log_message "ComputeModule init"
  sudo mount /dev/sda1 /home/robot/external/ -o uid=robot -o gid=robot

elif [[ $HOSTNAME == *"GPUModule"* ]]; then
    log_message "GPUModule init"
fi

ulimit -c unlimited
sudo bash -c 'echo core.%e.%p > /proc/sys/kernel/core_pattern'
#sleep 1


sudo chown -R robot /var/log/
log_message "Starting Boot Script"
#Device Type launch stuff
if [[ $HOSTNAME == *"ControlModule"* ]]; then
  log_message "ControlModule booting"
  log_message "Setting permissions on SPI" 
  sudo chown robot:robot /dev/spidev0.0
  sudo chown robot:robot /dev/spidev0.1
  log_message "Setting permissions on Video"
  sudo chown robot /dev/video0
  sudo chown robot /dev/vchiq
  echo 1 | sudo dd status=none of=/sys/class/leds/led1/brightness
  mkdir -p /home/robot/storage/DATALOGS/
  mkdir -p /home/robot/storage/AUDIO/
  mkdir -p /home/robot/storage/SNAPSHOT/SYSTEMSNAPSHOT/
  mkdir -p /home/robot/storage/SNAPSHOT/DEVICESNAPSHOT/
  sudo chown robot:robot /home/robot/storage/DATALOGS/
  sudo chown robot:robot /home/robot/storage/AUDIO/
  sudo chown robot:robot /home/robot/storage/SNAPSHOT/SYSTEMSNAPSHOT/
  sudo chown robot:robot /home/robot/storage/SNAPSHOT/DEVICESNAPSHOT/
  #cd /home/robot/linux-dash/app/server
  #echo "Starting Dashboard Server" >> $boot_file
  #sudo node index.js --port 81 2>> $boot_file >> $boot_file &
  #echo "Starting Watchdog" >> $boot_file
  #sudo service watchdog start
  #sleep 1
  #sudo service watchdog status >> $boot_file

elif [[ $HOSTNAME == *"ComputeModule"* ]]; then
  echo "ComputeModule booting" >> $boot_file
elif [[ $HOSTNAME == *"GPUModule"* ]]; then
  echo "GPUModule booting" >> $boot_file
  log_message "GPUModule booting"
  sudo service ntp start
  mkdir -p /home/robot/storage/DATALOGS/
  mkdir -p /home/robot/storage/AUDIO/
  mkdir -p /home/robot/storage/SNAPSHOT/SYSTEMSNAPSHOT/
  mkdir -p /home/robot/storage/SNAPSHOT/DEVICESNAPSHOT/
  sudo chown robot:robot /home/robot/storage/DATALOGS/
  sudo chown robot:robot /home/robot/storage/AUDIO/
  sudo chown robot:robot /home/robot/storage/SNAPSHOT/SYSTEMSNAPSHOT/
  sudo chown robot:robot /home/robot/storage/SNAPSHOT/DEVICESNAPSHOT/
fi

#Specific Device launch stuff
if [[ $HOSTNAME == "MasterModule" ]]; then
  log_message "MasterModule booting"
  simple_log "Setting permissions on SPI"
  sudo chown robot:robot /dev/spidev0.0
  sudo chown robot:robot /dev/spidev0.1
  log_message "Setting permissions on Video"
  sudo chown robot /dev/video0
  sudo chown robot /dev/vchiq
  echo 1 | sudo dd status=none of=/sys/class/leds/led1/brightness

  source /home/robot/catkin_ws/devel/setup.bash
  log_message "Starting ROSCore" 
  echo "roscore" | log_message
  #exec roscore 2>> $boot_file > /dev/null &
  
elif [[ $HOSTNAME == "ControlModule1" ]]; then
  mpg321 -g 30 /home/robot/storage/AUDIO/output/RobotPoweringUp.mp3
  cd /home/robot/catkin_ws
fi
log_message "Completed Boot."


if [[ $HOSTNAME == *"ControlModule"* ]]; then
    log_message "Launching Device"
    /home/robot/scripts/launchDevice -d $HOSTNAME
elif [[ $HOSTNAME == *"GPUModule"* ]]; then
    log_message "Launching Device"
    /home/robot/scripts/launchDevice -d $HOSTNAME
fi


log_message "Launching auxiliary nodes on modules." 
if [[ $HOSTNAME == "ControlModule1" ]]; then
    cd /home/robot/catkin_ws
    source /home/robot/catkin_ws/devel/setup.bash
    rosnode kill /raspicam_node
    #sleep 1
    log_message "starting nodes"
    echo "roslaunch raspicam_node camera.launch" | log_message
    echo "roslaunch sound_play soundplay_node.launch" | log_message
fi
log_message "Finished Launch."
